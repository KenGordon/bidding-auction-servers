# Copyright 2023 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# CIPD fetcher for component build pipelines
# CipdUrl release hash comes from depot_tools\cipd_client_version_ms.digests
parameters:
  CipdUrl: https://mscipdblobstorage.blob.core.windows.net/cipdreleases
  EsServicesClientId: 28ba6525-7ba4-4d83-8e82-d3ab1115e2f2
  EsServicesSubscription: edgees-ci-adopipeline
  EsServicesKeyVault: edgees-ci-adopipeline-kv

steps:
- task: Bash@3
  displayName: Clone depot_tools
  env:
    repo: https://microsoft.visualstudio.com/Edge/_git/chromium.depot_tools
  inputs:
    workingDirectory: $(Agent.BuildDirectory)
    targetType: 'inline'
    script: |
      git config --global core.autocrlf false
      git clone -c http.extraheader="AUTHORIZATION: bearer $(System.AccessToken)" $repo

- task: Powershell@2
  displayName: Add depot_tools to PATH
  inputs:
    targetType: 'inline'
    script: |
      echo '##vso[task.prependpath]$(Agent.BuildDirectory)/chromium.depot_tools'

- task: PowerShell@2
  displayName: View ES Services Secret Source
  inputs:
    workingDirectory: $(Agent.BuildDirectory)
    targetType: 'inline'
    script: |
      Write-Host "Client Id: ${{ parameters.EsServicesClientId }}"
      Write-Host "Service connection: ${{ parameters.EsServicesSubscription }}"
      Write-Host "Key Vault: ${{ parameters.EsServicesKeyVault }}"

- task: AzureKeyVault@1
  displayName: 'Download ES SSO secret from KeyVault with client ${{ parameters.EsServicesClientId }}'
  inputs:
    azureSubscription: '${{ parameters.EsServicesSubscription }}'
    keyVaultName: '${{ parameters.EsServicesKeyVault }}'
    secretsFilter: 'edgees-services-sp'

- task: PowerShell@2
  displayName: Get latest CIPD hash version
  inputs:
    workingDirectory: $(Agent.BuildDirectory)
    targetType: 'inline'
    script: |
      foreach ($line in (Get-Content chromium.depot_tools/cipd_client_version_ms.digests)) {
        if ($line.StartsWith("linux-amd64")) {
          # The cipd_client_version_ms.digests lines are structured as
          # "<architecture> sha256 <hash>", so we need the third token.
          $tokens = $line.Split(" ", [System.StringSplitOptions]::RemoveEmptyEntries)
          $setCipdHashVariableCommand = '##vso[task.setvariable variable=CipdHash]' + $tokens[2]
          Write-Output $setCipdHashVariableCommand
        }
      }

- task: CmdLine@2
  displayName: Download ms CIPD client
  inputs:
    workingDirectory: $(Agent.BuildDirectory)
    script: curl -o cipd.exe ${{ parameters.CipdUrl }}/$(CipdHash)

- bash: |
    set -euo pipefail

    client_id='${{ parameters.EsServicesClientId }}'
    client_secret='$(edgees-services-sp)'

    echo "Client version:"
    es --version

    echo "Logging in with service principal identity: ${client_id}"
    echo "${client_secret}" | es login --identity "${client_id}"
    echo "Login successful!"
  displayName: Login to ES services
